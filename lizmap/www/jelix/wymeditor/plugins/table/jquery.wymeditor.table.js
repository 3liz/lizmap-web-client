"use strict";function TableEditor(options,wym){var tableEditor=this;options=jQuery.extend({sMergeRowButtonHtml:String()+'<li class="wym_tools_merge_row">'+'<a name="merge_row" href="#" title="Merge Cells" '+'style="background-image: '+"url('"+wym._options.basePath+"plugins/table/table_join_row.png')"+'">'+'Merge Table Row'+'</a>'+'</li>',sMergeRowButtonSelector:"li.wym_tools_merge_row a",sAddRowButtonHtml:String()+"<li class='wym_tools_add_row'>"+"<a name='add_row' href='#' "+"title='Add Row' "+"style='background-image:"+" url("+wym._options.basePath+"plugins/table/table_insert_row.png)'>"+"Add Table Row"+"</a>"+"</li>",sAddRowButtonSelector:"li.wym_tools_add_row a",sRemoveRowButtonHtml:String()+"<li class='wym_tools_remove_row'>"+"<a name='remove_row' href='#' "+"title='Remove Row' "+"style='background-image: "+"url("+wym._options.basePath+"plugins/table/table_delete_row.png)'>"+"Remove Table Row"+"</a>"+"</li>",sRemoveRowButtonSelector:"li.wym_tools_remove_row a",sAddColumnButtonHtml:String()+"<li class='wym_tools_add_column'>"+"<a name='add_column' href='#' "+"title='Add Column' "+"style='background-image: "+"url("+wym._options.basePath+"plugins/table/table_insert_column.png)'>"+"Add Table Column"+"</a>"+"</li>",sAddColumnButtonSelector:"li.wym_tools_add_column a",sRemoveColumnButtonHtml:String()+"<li class='wym_tools_remove_column'>"+"<a name='remove_column' href='#' "+"title='Remove Column' "+"style='background-image: "+"url("+wym._options.basePath+"plugins/table/table_delete_column.png)'>"+"Remove Table Column"+"</a>"+"</li>",sRemoveColumnButtonSelector:"li.wym_tools_remove_column a",enableCellTabbing:true},options);tableEditor._options=options;tableEditor._wym=wym;tableEditor.init()}WYMeditor.editor.prototype.table=function(options){var wym=this,tableEditor=new TableEditor(options,wym);wym.tableEditor=tableEditor;return tableEditor};TableEditor.prototype.init=function(){var tableEditor=this,wym=tableEditor._wym,tools=jQuery(wym._box).find(wym._options.toolsSelector+wym._options.toolsListSelector);tools.append(tableEditor._options.sMergeRowButtonHtml);tools.append(tableEditor._options.sAddRowButtonHtml);tools.append(tableEditor._options.sRemoveRowButtonHtml);tools.append(tableEditor._options.sAddColumnButtonHtml);tools.append(tableEditor._options.sRemoveColumnButtonHtml);tableEditor.bindEvents();rangy.init()};TableEditor.prototype.bindEvents=function(){var tableEditor=this,wym=tableEditor._wym;jQuery(wym._box).find(tableEditor._options.sMergeRowButtonSelector).click(function(){var sel=wym.selection();tableEditor.mergeRow(sel);return false});jQuery(wym._box).find(tableEditor._options.sAddRowButtonSelector).click(function(){return tableEditor.addRow(wym.selectedContainer())});jQuery(wym._box).find(tableEditor._options.sRemoveRowButtonSelector).click(function(){return tableEditor.removeRow(wym.selectedContainer())});jQuery(wym._box).find(tableEditor._options.sAddColumnButtonSelector).click(function(){return tableEditor.addColumn(wym.selectedContainer())});jQuery(wym._box).find(tableEditor._options.sRemoveColumnButtonSelector).click(function(){return tableEditor.removeColumn(wym.selectedContainer())});if(tableEditor._options.enableCellTabbing){jQuery(wym._doc).bind('keydown',tableEditor.keyDown)}};TableEditor.prototype.getNumColumns=function(tr){var tableEditor=this,wym=tableEditor._wym,numColumns=0,table,firstTr;table=wym.findUp(tr,'table');firstTr=jQuery(table).find('tr:eq(0)');jQuery(firstTr).children('td,th').each(function(index,elmnt){numColumns+=TableEditor.GET_COLSPAN_PROP(elmnt)});return numColumns};TableEditor.GET_COLSPAN_PROP=function(cell){var colspan=jQuery(cell).attr('colspan');if(typeof colspan==='undefined'){colspan=1}return parseInt(colspan,10)};TableEditor.GET_ROWSPAN_PROP=function(cell){var rowspan=jQuery(cell).attr('rowspan');if(typeof rowspan==='undefined'){rowspan=1}return parseInt(rowspan,10)};TableEditor.prototype.getCellXIndex=function(cell){var tableEditor=this,i,parentTr,baseRowColumns,rowColCount,missingCells,rowspanIndexes,checkTr,rowOffset,trChildren,elmnt,colspan,indexCounter,cellIndex;parentTr=jQuery(cell).parent('tr')[0];baseRowColumns=tableEditor.getNumColumns(parentTr);rowColCount=0;jQuery(parentTr).children('td,th').each(function(index,elmnt){rowColCount+=TableEditor.GET_COLSPAN_PROP(elmnt)});missingCells=baseRowColumns-rowColCount;rowspanIndexes=[];checkTr=parentTr;rowOffset=1;while(missingCells>0){checkTr=jQuery(checkTr).prev('tr');rowOffset+=1;trChildren=jQuery(checkTr).children('td,th');for(i=0;i<trChildren.length;i++){elmnt=trChildren[i];if(TableEditor.GET_ROWSPAN_PROP(elmnt)>=rowOffset){missingCells-=1;colspan=TableEditor.GET_COLSPAN_PROP(elmnt);rowspanIndexes[tableEditor.getCellXIndex(elmnt)]=colspan}}}indexCounter=0;cellIndex=null;jQuery(parentTr).children('td,th').each(function(index,elmnt){if(cellIndex!==null){return}while(typeof rowspanIndexes[indexCounter]!=='undefined'){indexCounter+=parseInt(rowspanIndexes[indexCounter],10)}if(elmnt===cell){cellIndex=indexCounter;return}indexCounter+=TableEditor.GET_COLSPAN_PROP(elmnt)});if(cellIndex===null){throw"Cell index not found"}return cellIndex};TableEditor.prototype.getTotalColumns=function(cells){var tableEditor=this,rootTr=tableEditor.getCommonParentTr(cells),baseRowColumns,colspanCount,rowColCount,lastCell,firstCell;if(rootTr===null){throw"getTotalColumns only allowed for contiguous cells"}baseRowColumns=tableEditor.getNumColumns(rootTr);colspanCount=0;jQuery(cells).each(function(index,elmnt){colspanCount+=TableEditor.GET_COLSPAN_PROP(elmnt)});rowColCount=0;jQuery(rootTr).children('td,th').each(function(index,elmnt){rowColCount+=TableEditor.GET_COLSPAN_PROP(elmnt)});if(rowColCount===baseRowColumns){return colspanCount}else{if(cells.length===1){return TableEditor.GET_COLSPAN_PROP(cells[0])}else{lastCell=jQuery(cells).eq(cells.length-1)[0];firstCell=jQuery(cells).eq(0)[0];return 1+tableEditor.getCellXIndex(lastCell)-tableEditor.getCellXIndex(firstCell)}}};TableEditor.prototype.mergeRow=function(sel){var tableEditor=this,wym=tableEditor._wym,i,nodes=[],range=null,cells,rootTr,mergeCell,$elmnt,rowspanProp,newContent,combinedColspan;for(i=0;i<sel.rangeCount;i++){range=sel.getRangeAt(i);nodes=nodes.concat(range.getNodes(false))}rangy.getIframeSelection(wym._iframe).removeAllRanges();cells=jQuery(nodes).filter('td,th');if(cells.length===0){return false}rootTr=tableEditor.getCommonParentTr(cells);if(rootTr===null){return false}mergeCell=cells[0];jQuery(cells).each(function(i,elmnt){$elmnt=jQuery(elmnt);rowspanProp=TableEditor.GET_ROWSPAN_PROP(elmnt);if(rowspanProp<=1){return}var index=tableEditor.getCellXIndex(elmnt),newRowspan=rowspanProp-1,newTd,insertionIndex,insertionCells,cellInserted,xIndex;if(newRowspan===1){newTd='<td>'+$elmnt.html()+'</td>'}else{newTd=String()+'<td rowspan="'+newRowspan+'">'+$elmnt.html()+'</td>'}if(index===0){$elmnt.parent('tr').next('tr').prepend(newTd)}else{insertionIndex=index-1;insertionCells=$elmnt.parent('tr').next('tr').find('td,th');cellInserted=false;for(i=insertionCells.length-1;i>=0;i--){xIndex=tableEditor.getCellXIndex(insertionCells[i]);if(xIndex<=insertionIndex){jQuery(insertionCells[i]).append(newTd);cellInserted=true;break}}if(!cellInserted){throw"Cell rowspan invalid"}}$elmnt.html('')});try{jQuery(mergeCell).removeAttr('rowspan')}catch(err){jQuery(mergeCell).attr('rowspan',1)}newContent='';jQuery(cells).each(function(index,elmnt){newContent+=jQuery(elmnt).html()});combinedColspan=tableEditor.getTotalColumns(cells);if(jQuery.browser.msie){mergeCell.colSpan=combinedColspan}else{jQuery(mergeCell).attr('colspan',combinedColspan)}jQuery(cells).each(function(index,elmnt){if(index!==0){jQuery(elmnt).remove()}});jQuery(mergeCell).html(newContent);tableEditor.selectElement(mergeCell);return true};TableEditor.prototype.addRow=function(elmnt){var tableEditor=this,tr=tableEditor._wym.findUp(elmnt,'tr'),numColumns,tdHtml,i;if(tr===null){return false}numColumns=tableEditor.getNumColumns(tr);tdHtml='';for(i=0;i<numColumns;i++){tdHtml+='<td>&nbsp;</td>'}jQuery(tr).after('<tr>'+tdHtml+'</tr>');return false};TableEditor.prototype.removeEmptyTable=function(table){var cells=jQuery(table).find('td,th');if(cells.length===0){jQuery(table).remove()}};TableEditor.prototype.removeRow=function(elmnt){var tableEditor=this,wym=tableEditor._wym,tr=wym.findUp(elmnt,'tr'),table;if(tr===null){return false}table=wym.findUp(elmnt,'table');jQuery(tr).remove();tableEditor.removeEmptyTable(table);return false};TableEditor.prototype.addColumn=function(elmnt){var tableEditor=this,wym=tableEditor._wym,td=wym.findUp(elmnt,['td','th']),prevTds,tdIndex,tr,newTd='<td>&nbsp;</td>',newTh='<th>&nbsp;</th>',insertionElement;if(td===null){return false}prevTds=jQuery(td).prevAll();tdIndex=prevTds.length;tr=wym.findUp(td,'tr');jQuery(tr).siblings('tr').andSelf().each(function(index,element){insertionElement=newTd;if(jQuery(element).find('th').length>0){insertionElement=newTh}jQuery(element).find('td,th').eq(tdIndex).after(insertionElement)});return false};TableEditor.prototype.removeColumn=function(elmnt){var tableEditor=this,wym=tableEditor._wym,td=wym.findUp(elmnt,['td','th']),table,prevTds,tdIndex,tr;if(td===null){return false}table=wym.findUp(elmnt,'table');prevTds=jQuery(td).prevAll();tdIndex=prevTds.length;tr=wym.findUp(td,'tr');jQuery(tr).siblings('tr').each(function(index,element){jQuery(element).find('td,th').eq(tdIndex).remove()});jQuery(td).remove();tableEditor.removeEmptyTable(table);return false};TableEditor.prototype.keyDown=function(evt){var doc=this,wym=WYMeditor.INSTANCES[doc.title],tableEditor=wym.tableEditor;if(evt.which===WYMeditor.KEY.TAB){return tableEditor.selectNextCell(wym.selectedContainer())}return null};TableEditor.prototype.selectNextCell=function(elmnt){var tableEditor=this,wym=tableEditor._wym,cell=wym.findUp(elmnt,['td','th']),nextCells,tr,nextRows;if(cell===null){return null}nextCells=jQuery(cell).next('td,th');if(nextCells.length>0){tableEditor.selectElement(nextCells[0]);return false}tr=wym.findUp(cell,'tr');nextRows=jQuery(tr).next('tr');if(nextRows.length!==0){nextCells=jQuery(nextRows).children('td,th');if(nextCells.length>0){tableEditor.selectElement(nextCells[0]);return false}}return null};TableEditor.prototype.selectElement=function(elmnt){var tableEditor=this,wym=tableEditor._wym,sel=wym.selection(),range=rangy.createRange(wym._doc);range.setStart(elmnt,0);range.setEnd(elmnt,0);range.collapse(false);try{sel.setSingleRange(range)}catch(err){}if(WYMeditor.isInternetExplorerPre11()){wym.saveCaret()}};TableEditor.prototype.getCommonParentTr=function(cells){var firstCell,parentTrList,rootTr;cells=jQuery(cells).filter('td,th');if(cells.length===0){return null}firstCell=cells[0];parentTrList=jQuery(firstCell).parent('tr');if(parentTrList.length===0){return null}rootTr=parentTrList[0];jQuery(cells).each(function(index,elmnt){parentTrList=jQuery(elmnt).parent('tr');if(parentTrList.length===0||parentTrList[0]!==rootTr){return null}});return rootTr};