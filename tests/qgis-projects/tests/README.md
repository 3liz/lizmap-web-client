# Tests projects

## Project files

In this directory for every test you will find :

* a QGIS project (*.qgs) saved with the [qgis_trackable_project_files plugin](https://github.com/opengisch/qgis_trackable_project_files)
* a Lizmap configuration (*.qgs.cfg)
* an optional markdown describing the manual tests scenarios (*.md)

Those files share the same name, only extension is different.

## Data

The PostgreSQL dump (schema + data) `tests_dataset.sql` contains all data to run tests.
* Command to dump (don't forget to remove data generated by running tests before) :
    * All data : `pg_dump -d "service=lizmapdb" --no-owner --no-acl -n tests_projects -f tests_dataset.sql`
    * Some tables : `pg_dump -d "service=lizmapdb" -t tests_projects.XXX -t tests_projects.YYY --no-owner --no-acl -n tests_projects -f to_merge.sql`

* Commands to restore :
  ```bash
  # Add all the tables and data in the schema tests_dataset
  psql service=lizmapdb -f tests_dataset.sql
  ```

## Using another service

*Quick and dirty* process to use these projects on another DB :

* service `qgis_test`
* Lizmap repository called in the UI `testsrepository`

```bash
# Replace service name in QGIS projects
./replace_database_connection_qgs_project.sh /home/etienne/dev/lizmap/lizmap-master/tests/qgis-projects/tests/ qgis_test

# Transfert files with FTP

# Clean existing schema in PG
PGPASSWORD=PASSWORD psql -h localhost -p 5432 -U USER -n -d qgis_test -c "DROP SCHEMA IF EXISTS tests_projects CASCADE"
psql service=SERVICE -n -c "DROP SCHEMA IF EXISTS tests_projects CASCADE"

# Insert users needed for tests, maybe truncate ?
# Change the LWC version
sed -i "s#INSERT INTO lizmap\.#INSERT INTO lizmap_lizmap_3_5\.#g" set_tests_respository_rights.sql

# Make the PG query
PGPASSWORD=PASSWORD psql -h localhost -p 5432 -U USER -d DB_NAME -f set_tests_respository_rights.sql
psql service=SERVICE -f set_tests_respository_rights.sql

# Import data, check there isn't any ACL before
psql service=SERVICE -f tests_dataset.sql
psql service=SERVICE -f set_tests_lizmap_search.sql
psql service=SERVICE -f set_tests_module_action.sql
```
