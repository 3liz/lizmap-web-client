# Testing Lizmap

## Installation

A docker configuration is provided to launch Lizmap into a container.

This Docker Compose project is using :

* [3liz/postgis](https://hub.docker.com/r/3liz/postgis/tags)
* [3liz/qgis-map-server](https://hub.docker.com/r/3liz/qgis-map-server/tags)

### With Windows

1. Install [Docker](https://docs.docker.com/desktop/windows/install/)
2. Install [Git](https://git-scm.com/download/win)
3. Launch Git Bash as administrator (right-click, run as administrator), then in the new window...
```bash
# Create a directory for Git repositories
mkdir GIT
# Git clone Lizmap Web Client in this directory
cd GIT && git clone https://github.com/3liz/lizmap-web-client.git --config core.autocrlf=input
# Go to tests repository
cd lizmap-web-client/tests/
# Download Lizmap plugin for QGIS Server
# https://packages.3liz.org/pub/lizmap-qgis-plugin/master/lizmap-qgis-plugin.master.zip
# and unzip the content in `qgis-server-plugins/` directory
# Launch Lizmap Web Client with docker compose
docker compose --env-file .env.windows up
# You can now go to http://localhost:8130 and test

# Later, you can get the latest changes in Lizmap Web Client with:
git pull
```

### With Linux

You must install Docker on your machine first. Then execute `make run`

To launch containers for the first time, with your current user:

```bash
make clean
make build
```

Then:

```bash
make install
```

Then, in your browser, go to `http://localhost:8130/`. (see below to change the port)

Optionally, you can set `lizmap.local` into your `/etc/hosts`, as well as `othersite.local`
for some tests:

```bash
127.0.0.1 lizmap.local
127.0.0.1 othersite.local
```

Then, in your browser, go to `http://lizmap.local:8130/`. (see below to change the port)

To stop containers:

```bash
make stop
```

You may have to close connections to the postgresql database if you are using
PgAdmin for example, before stopping containers.

## Access locally through HTTPS

To do so, you need `mkcert`

```bash
sudo apt install mkcert libnss3-tools -y
mkcert -install
```
The -install step creates and installs the local CA. You'll see output like:

```bash
Created a new local CA üí•
The local CA is now installed in the system trust store! ‚ö°Ô∏è
The local CA is now installed in the Firefox and/or Chrome/Chromium trust store (requires browser restart)! ü¶ä
```

Then, in your browser, go to `http://lizmap.local:8135/`. (see below to change the port)

To update the certificates for `lizmap.local` :

```bash
mkcert -cert-file docker-conf/certs/lizmap.local.crt -key-file docker-conf/certs/lizmap.local.key lizmap.local

Created a new certificate valid for the following names üìú
 - "lizmap.local"

The certificate is at "docker-conf/certs/lizmap.local.crt" and the key at "docker-conf/certs/lizmap.local.key" ‚úÖ

It will expire on 5 February 2028 üóì
```

To update the certificates for `othersite.local` :

```bash
mkcert -cert-file docker-conf/certs/othersite.local.crt -key-file docker-conf/certs/othersite.local.key othersite.local

Created a new certificate valid for the following names üìú
 - "othersite.local"

The certificate is at "docker-conf/certs/othersite.local.crt" and the key at "docker-conf/certs/othersite.local.key" ‚úÖ

It will expire on 5 February 2028 üóì
```

## Available commands

You can execute some commands into the PHP container or other containers, by using this command:

```bash
./lizmap-ctl <command>
```

Available commands :

* `clean`: delete all files generated by the build process.
* `reset`: to reinitialize the application (with lizmap data stored into Postgresql)
* `reset-sqlite`: to reinitialize the application (with lizmap data stored into sqlite)
* `composer-update` and `composer-install`: to update PHP packages
* `clean-tmp`: to delete temp files
* `install`: to launch the Jelix installer
* `script`: to launch lizmap command line like `wmts`
* `docker-exec` : exec command into the php container
* `shell` and `shell-root` : to enter into the php container
* `ldap-reset` to reset the ldap content, and `ldap-users` to store some users for tests
* `psql` to enter into the interactive command line of postgresql (psql)
* `redis-cli` to enter into the interactive command line of Redis (redis-cli)
* `phpstan` to launch PHP code quality tool phpstan

## Accessing to Postgresql

If you want to use pgAdmin or any other postgresql client, access credentials from your
computer are:

- host: `localhost`
- port: 8132 (see below to change the port)
- database: `lizmap`
- user: `lizmap`
- password: `lizmap1234!`

However, you must not indicate these credentials in your QGIS projects for tests,
because host and port are different when accessing from your computer, and when
accessing from one of the containers, like QGIS or lizmap.

A postgresql service named  `lizmapdb` is configured in containers.
So you must use it as access parameter in your QGIS projects, with the database name `lizmap`.

In order to set the service from QGIS Desktop, you must create the file
`~/.pg_service.conf` and put these parameters in it:

```ini
[lizmapdb]
host=localhost
port=8132
user=lizmap
password=lizmap1234!
```

## Accessing to Swagger for admin API

Swagger is not launched by default so you need to start the stack this way:

```bash
docker compose --profile dev up -d
```

If you want to test or learn about the API, after having set up the stack, you can access
to http://localhost:8133/ and find the Swagger page.

If you want to update this page, you can modify the [./api/openapi.yaml](./api/openapi.yaml) file.

## Admin User Account Setup

Default admin credentials are `admin`/`admin`, to modify it, set these variables in your environment,
default values provided:
- `LIZMAP_ADMIN_LOGIN`: Login of the admin user
- `LIZMAP_ADMIN_EMAIL`: Email address of the admin user, it will be used by the password reset process.
- `LIZMAP_ADMIN_DEFAULT_PASSWORD_SOURCE`: The password source to user for the admin user, it can either be:
    - `__reset`: It will initiate a password reset process.
      An email will be sent to `LIZMAP_ADMIN_EMAIL` with a link to choose a new password.
    - `__random`: Will set a random password that will be report into the command line (see `docker logs` to access it).
    - `/path/to/pass/file`: The path to a file containing your password. The file must be used as a volume for docker to access it.


## Setting port numbers for services

You can modify port to access to the web server, the postgresql server or QGIS Server,
by creating some environment variable, `LZMWEBPORT`, `LZMPGPORT` or `LZMQGSRVPORT`.

Example:

```bash
export LZMPGPORT=8150
export LZMWEBPORT=8151
export LZMQGSRVPORT=8152
export QGSRVAPIPORT=8134

make up

# you can then open browser at :
# http://localhost:8151/ for Lizmap Web Client
# http://localhost:8134/ for Py-QGIS-Server

```

## Changing PHP, PostgreSQL and QGIS versions

You can change the version of some softwares to use, by setting
some environment variables:

- `PHP_VERSION` to set the PHP version
- `LZMQGSRVVERSION` to set the QGIS version
- `LZMPOSTGISVERSION` to set the PostgreSQL/PostGIS version
  (the format is `X-Y` where `X` is the major version of postgresql, and `Y` the major version of PostGIS)

You must set these (optional) environment variables, **before** building the stack.

```bash
export PHP_VERSION=8.3
export LZMQGSRVVERSION=3.42
export LZMPOSTGISVERSION=17-3
make build
```

## Running different docker stack for each branch

By default, name of containers are different for each branch, so you can build
and run a docker stack for each branch of the repository. Name of containers
are made with the name of the current branch. You set a different name by creating
an environment variable `LZMBRANCH` before running `make run` or `lizmap-ctl`.

Example:

```bash
export LZMBRANCH=another-name

make build up
./lizmap-ctl reset
# etc...

```

Port to access to the postgresql server and the nginx server
are the same on each branch, by default. So if you want to run different stack
at the same time, you will have some error. You must then change the port. See above.


## Automatic PHP tests

The `units` directory contains some unit tests.

To launch PHP tests:

- Launch the lizmap application as indicated above.
- launch `./lizmap-ctl unit-tests`


## Automatic JavaScript tests

The `js-units` directory contains some unit tests.

In the **root** directory :

* Run `npm install` to install Mocha
* `npm run js:test` to run the JavaScript unit tests

## Testing data

You must execute `tests/qgis-projects/tests/load_sql.sh` to populate PostgreSQL database with testing data.

## Automatic End-to-End tests

*First add testing data as explained above.*

The `end2end` directory contains some end-to-end tests made for Playwright and BATS.

In the **root** directory, `npm install` to install Playwright and Bats.

### Playwright

You have to install the browsers with `npx playwright install` (only the first time or after an update)
You can then run:
- `npx playwright test --config tests/end2end/playwright.config.ts` to execute all tests with all browsers
And optionnaly add:
- `--ui` to open a UI
- `--grep @readonly --workers 4` to run tests with 4 workers for tests which are read-only
- `--project=chromium` to execute all tests with the Chromium browser
- `--grep-invert "test_a|test_b"` to execute all tests but "test_a" and "test_b"
- `mytest.spec.js` to execute one test
- `--debug` to execute in debug mode
- other command line : https://playwright.dev/docs/intro#command-line

You can also install the handy [Playwright extension](https://marketplace.visualstudio.com/items?itemName=ms-playwright.playwright) on VSCode.

#### Writing tests

A test doing only a **read-only** on Lizmap must be tagged as `@readonly`, otherwise, it must be tagged `@write`.
If it's performing only **requests** to the API, it must be tagged as `@requests`.

#### Artifacts

When GitHub Action is failing, all screenshots and downloaded files are uploaded in an ZIP.
It's available in the CI **Summary page** of the CI job.

#### Mouse coordinates

In Firefox, you can enable and use the [measuring tool](https://firefox-source-docs.mozilla.org/devtools-user/measure_a_portion_of_the_page/index.html).

You need to be sure to use the same viewport size as Playwright : `900 * 650 DPR 1`.
We suggest you to save those configurations in `Settings` => `Emulated Devices` as `Playwright`.

### Bats

Bats (Bash Automated Testing System) is a TAP-compliant testing framework for Bash 3.2 or above. It provides a simple way to verify that the UNIX programs you write behave as expected. Bats is most useful when testing software written in Bash, but you can use it to test any UNIX program.

https://bats-core.readthedocs.io/

Bats is here used to test PHP console command.

To run bats tests, you can use the command `npm run bats`.


## Manual tests

*First add testing data as explained above.*

Put your projects into `tests/qgis-projects/tests/` (replace `tests` by the name
of your choice), and then you can declare `tests` projects into
the admin page of Lizmap, or in its `var/config/lizmapConfig.ini.php`.

To test CORS, you can load `http://othersite.local:8130`, click on the buttons,
and check the JS console for errors.

To test PHP session cookie, you can load `https://othersite.local:8135/embed.html`

## ESLint

Eslint can be run if you're located in `assets/`.

```bash
# Run eslint without fixing issues
npm run pretest

# Run eslint and fix issues
npm run pretest:fix
```

## PHP Rector

[PHP Rector](https://getrector.com/) can be run if you're located in `tests/units`.

```bash
# Install composer dependencies
composer install

# Run PHP Rector without fixing issues
composer rector

# Run PHP Rector and fix issues
composer rector:fix
```

## Using LDAP

LDAP is not launched by default so you need to start the stack this way:

```bash
docker compose --profile dev up -d
```

Into `lizmap/var/config/localconfig.ini.php`:

1. set `ldapdao.access=2` into the `modules` section
2. set `driver=ldapdao` into the `coordplugin_auth` section
3. launch `lizmap-ctl  install`

Be sure there are users into the ldap: execute `lizmap-ctl ldap-users`. It should
show a list of users (Jane and John). If there are not present, launch `lizmap-ctl ldap-reset`.

You should then be able to connect yourself into lizmap with login `jane` (password: `passjane`) or
login `john` (password: `passjohn`).

## Using Redis for cache

Into `lizmap/var/config/lizmapConfig.ini.php`, set `cacheStorageType=redis`
into the `services` section.

Into `lizmap/var/config/profiles.ini.php`, uncomment parameters into the `jcache:qgisprojects`
section.

You can inspect the content of Redis with `lizmap-ctl redis-cli`.
