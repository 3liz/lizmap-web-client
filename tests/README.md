# Testing Lizmap

## Docker build

A docker configuration is provided to launch Lizmap into a container.
You must install Docker on your machine first. Then you should execute
the run-docker script.

To launch containers for the first time, with your current user:

```bash
./lizmap-ctl clean
./run-docker build
```

Then:

```bash
./run-docker
./lizmap-ctl install
```

You must set `lizmap.local` into your `/etc/hosts`:

```bash
127.0.0.1 lizmap.local
```

Then, in your browser, go to `http://lizmap.local:8130/`. (see below to change the port)

To stop containers:

```bash
./run-docker stop
```

You may have to close connections to the postgresql database if you are using
PgAdmin for example, before stopping containers.

You can execute some commands into the php container or other containers, by using this command:

```bash
./lizmap-ctl <command>
```

Available commands :

* `clean`: delete all files generated by the build process.
* `reset`: to reinitialize the application (with lizmap data stored into Postgresql) 
* `reset-sqlite`: to reinitialize the application (with lizmap data stored into sqlite) 
* `composer_update` and `composer_install`: to update PHP packages 
* `clean_tmp`: to delete temp files 
* `install`: to launch the Jelix installer
* `shell` and `shellroot` : to enter into the php container
* `ldapreset` to reset the ldap content, and `ldapusers` to store some users for tests
* `pgsql` to enter into the interactive command line of postgresql (psql)
* `redis-cli` to enter into the interactive command line of Redis (redis-cli)

## Accessing to Postgresql

If you want to use pgadmin or any other postgresql client, access credentials from your
computer are:

- host: `localhost`
- port: 8132 (see below to change the port)
- database: `lizmap`
- user: `lizmap`
- password: `lizmap1234!`

However, you must not indicate these credentials in your QGIS projects for tests,
because host and port are different when accessing from your computer, and when
accessing from one of the containers, like QGIS or lizmap.

A postgresql service named  `lizmapdb` is configured in containers. 
So you must use it as access parameter in your QGIS projects, with the database name `lizmap`.
 
In order to set the service from QGIS Desktop, you must create the file
`~/.pg_service.conf` and put these parameters in it:

```ini
[lizmapdb]
host=localhost
port=8132
user=lizmap
password=lizmap1234!
```

## Admin User Account Setup

Default admin credentials are `admin`/`admin`, to modify it, set these variables in your environment, default values are provided in `run-docker` : 
- `LIZMAP_ADMIN_LOGIN`: Login of the admin user
- `LIZMAP_ADMIN_EMAIL`: Email address of the admin user, it will be used by the password reset process.
- `LIZMAP_ADMIN_DEFAULT_PASSWORD_SOURCE`: The password source to user for the admin user, it can either be: 
    - `__reset`: It will initiate a password reset process, an email will be sent to `LIZMAP_ADMIN_EMAIL` with a link to choose a new password.
    - `__random`: Will set a random password that will be report into the command line (see `docker logs` to access it).
    - `/path/to/pass/file`: The path to a file containing your password. The file must be used as a volume for docker to access it.


## Setting port numbers for services

You can modify port to access to the web server, the postgresql server or QGIS Server,
by creating some environment variable, `LZMWEBPORT`, `LZMPGPORT` or `LZMQGSRVPORT`.

Example:

```bash
export LZMPGPORT=8150
export LZMWEBPORT=8151
export LZMQGSRVPORT=8152

./run-docker up -d

# you can then open browser at http://localhost:8151/

```

## Running different docker stack for each branch

By default, name of containers are different for each branch, so you can build 
and run a docker stack for each branch of the repository. Name of containers
are made with the name of the current branch. You set a different name by creating
an environment variable `LZMBRANCH` before running `run-docker` or `lizmap-ctl`.

Example:

```bash
export LZMBRANCH=another-name

./run-docker build
./run-docker up -d
./lizmap-ctl reset
# etc...

```

Port to access to the postgresql server and the nginx server
are the same on each branch, by default. So if you want to run different stack
at the same time, you will have some error. You must then change the port. See above.
 

## Automatic PHP tests

The `units` directory contains some unit tests.

To launch PHP tests:

- Launch the lizmap application as indicated above.
- launch `./lizmap-ctl unittests`

## Automatic End-to-End tests

The `js` directory contains some end-to-end tests.

## Manual tests

Put your projects into `tests/qgis_projects/tests/` (replace `tests` by the name
of your choice), and then you can declare `tests` projects into
the admin page of Lizmap, or in its `var/config/lizmapConfig.ini.php`.

## Using LDAP

Into `lizmap/var/config/localconfig.ini.php`:

1. set `ldapdao.access=2` into the `modules` section
2. set `driver=ldapdao` into the `coordplugin_auth` section
3. launch `lizmap-ctl  install`

Be sure there are users into the ldap: execute `lizmap-ctl ldapusers`. It should 
show a list of users (Jane and John). If there are not present, launch `lizmap-ctl ldapreset`.

You should then be able to connect yourself into lizmap with login jane (password: passjane) or
login john (password: passjohn).

## Using Redis for cache

Into `lizmap/var/config/lizmapConfig.ini.php`, set `cacheStorageType=redis`
into the `services` section.

Into `lizmap/var/config/profiles.ini.php`, uncomment parameters into the `jcache:qgisprojects`
section.

You can inspect the content of Redis with `lizmap-ctl redis-cli`.
